(()=>{"use strict";let e,t,n;var i={},o={};function r(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return i[e](n,n.exports,r),n.exports}function s(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.config)?void 0:t.readConfig))return JSON.parse(globalThis.AstroBox.config.readConfig());throw Error("AstroBox.config.readConfig not available on native side")}function l(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.config)?void 0:n.writeConfig))globalThis.AstroBox.config.writeConfig(JSON.stringify(e));else throw Error("AstroBox.config.writeConfig not available on native side")}function a(e){let t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",i,o=e.length;for(i=2;i<o;i+=3)n+=t[e[i-2]>>2],n+=t[(3&e[i-2])<<4|e[i-1]>>4],n+=t[(15&e[i-1])<<2|e[i]>>6],n+=t[63&e[i]];return i===o+1&&(n+=t[e[i-2]>>2],n+=t[(3&e[i-2])<<4],n+="=="),i===o&&(n+=t[e[i-2]>>2],n+=t[(3&e[i-2])<<4|e[i-1]>>4],n+=t[(15&e[i-1])<<2],n+="="),n}function c(e){if((e=e.replace(/[\r\n\s]/g,"")).length%4!=0)throw Error("Invalid base64 string length");let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0;e.endsWith("==")?n=2:e.endsWith("=")&&(n=1);let i=e.length/4*3-n,o=new Uint8Array(i),r=0;for(let n=0;n<e.length;n+=4){let s=t.indexOf(e[n])<<18|t.indexOf(e[n+1])<<12|t.indexOf(e[n+2])<<6|t.indexOf(e[n+3]);r<i&&(o[r++]=s>>16&255),r<i&&(o[r++]=s>>8&255),r<i&&(o[r++]=255&s)}return o}async function u(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.debug)?void 0:n.sendRaw))await globalThis.AstroBox.debug.sendRaw(a(e));else throw Error("AstroBox.debug.sendRaw not available on native side")}function d(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:t.getDeviceList))return JSON.parse(globalThis.AstroBox.device.getDeviceList());throw Error("AstroBox.device.getDeviceList not available on native side")}function h(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.device)?void 0:n.getDeviceState))return JSON.parse(globalThis.AstroBox.device.getDeviceState(e));throw Error("AstroBox.device.getDeviceState not available on native side")}function f(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.device)?void 0:i.modifyDeviceState))globalThis.AstroBox.device.modifyDeviceState(e,JSON.stringify(t));else throw Error("AstroBox.device.modifyDeviceState not available on native side")}async function v(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:t.disconnectDevice))await globalThis.AstroBox.device.disconnectDevice();else throw Error("AstroBox.device.disconnectDevice not available on native side")}function g(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.event)?void 0:i.addEventListener))globalThis.AstroBox.event.addEventListener(e,t);else throw Error("AstroBox.event.addEventListener not available")}function p(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.event)?void 0:n.removeEventListener))globalThis.AstroBox.event.removeEventListener(e);else throw Error("AstroBox.event.removeEventListener not available")}function y(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.event)?void 0:i.sendEvent))globalThis.AstroBox.event.sendEvent(e,t);else throw Error("AstroBox.event.sendEvent not available")}function b(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),i.forEach(function(t){var i;i=n[t],t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i})}return e}async function m(e){var t,n;let i=b({decode_text:!1,encoding:"undefined"},e);if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.filesystem)?void 0:n.pickFile))return JSON.parse(await globalThis.AstroBox.filesystem.pickFile(JSON.stringify(i)));throw Error("AstroBox.filesystem.pickFile not available")}async function x(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.filesystem)?void 0:i.readFile)){let n=b({offset:0,decode_text:!0},t);var o=await globalThis.AstroBox.filesystem.readFile(e,JSON.stringify(n));return n.decode_text?o:c(o)}throw Error("AstroBox.filesystem.readFile not available")}async function w(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.filesystem)?void 0:n.unloadFile))return await globalThis.AstroBox.filesystem.unloadFile(e);throw Error("AstroBox.filesystem.unloadFile not available")}function A(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.installer)?void 0:i[e]))globalThis.AstroBox.installer[e](t);else throw Error("AstroBox.installer.".concat(e," not available"))}r.rv=()=>"1.4.6",r.ruid="bundler=rspack@1.4.6";let O=e=>A("addThirdPartyAppToQueue",e),B=e=>A("addWatchFaceToQueue",e),k=e=>A("addFirmwareToQueue",e);async function T(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.interconnect)?void 0:i.sendQAICMessage))await globalThis.AstroBox.interconnect.sendQAICMessage(e,t);else throw Error("AstroBox.interconnect.sendQAICMessage not available")}function P(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.lifecycle)?void 0:n.onLoad))globalThis.AstroBox.lifecycle.onLoad(e);else throw Error("AstroBox.lifecycle.onLoad not available")}function S(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.native)?void 0:n.regNativeFun))return globalThis.AstroBox.native.regNativeFun(e);throw Error("AstroBox.native.regNativeFun not available")}async function E(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.network)?void 0:i.fetch)){t.body_encoded="string"!=typeof t.body,t.body=t.body?t.body_encoded?a(t.body):t.body:"";let n=await globalThis.AstroBox.network.fetch(e,JSON.stringify(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),i.forEach(function(t){var i;i=n[t],t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i})}return e}({raw:!1},t)));return n.body=t.raw?c(n.body):n.body,n}throw Error("AstroBox.network.fetch not available")}async function F(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.provider)?void 0:n.registerCommunityProvider))await globalThis.AstroBox.provider.registerCommunityProvider(JSON.stringify(e));else throw Error("AstroBox.provider.registerCommunityProvider not available")}async function C(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.thirdpartyapp)?void 0:i.launchQA))await globalThis.AstroBox.thirdpartyapp.launchQA(JSON.stringify(e),t);else throw Error("AstroBox.thirdpartyapp.launchQA not available")}async function j(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.thirdpartyapp)?void 0:t.getThirdPartyAppList))return JSON.parse(await globalThis.AstroBox.thirdpartyapp.getThirdPartyAppList());throw Error("AstroBox.thirdpartyapp.getThirdPartyAppList not available")}function L(e,t){var n,i;if("function"==typeof(null==(i=null==(n=globalThis.AstroBox)?void 0:n.ui)?void 0:i[e]))globalThis.AstroBox.ui[e](t);else throw Error("AstroBox.ui.".concat(e," not available"))}let _=e=>L("updatePluginSettingsUI",JSON.stringify(e)),N=e=>L("openPageWithNodes",JSON.stringify(e)),I=e=>L("openPageWithUrl",e),D={};function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.config={},e.config.readConfig=s,e.config.writeConfig=l,e.debug={},e.debug.sendRaw=u,e.device={},e.device.getDeviceList=d,e.device.getDeviceState=h,e.device.modifyDeviceState=f,e.device.disconnectDevice=v,e.event={},e.event.addEventListener=g,e.event.removeEventListener=p,e.event.sendEvent=y,e.installer={},e.installer.addThirdPartyAppToQueue=O,e.installer.addWatchFaceToQueue=B,e.installer.addFirmwareToQueue=k,e.interconnect={},e.interconnect.sendQAICMessage=T,e.lifecycle={},e.lifecycle.onLoad=P,e.native={},e.native.regNativeFun=S,e.network={},e.network.fetch=E,e.provider={},e.provider.registerCommunityProvider=F,e.thirdpartyapp={},e.thirdpartyapp.launchQA=C,e.thirdpartyapp.getThirdPartyAppList=j,e.ui={},e.ui.updatePluginSettingsUI=_,e.ui.openPageWithNodes=N,e.ui.openPageWithUrl=I,e.filesystem={},e.filesystem.pickFile=m,e.filesystem.readFile=x,e.filesystem.unloadFile=w}(D);class J{addListener(e,t){this.listeners.set(e,t)}removeListener(e){this.listeners.delete(e)}send(e,t){return D.interconnect.sendQAICMessage(this.packageName,JSON.stringify(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),i.forEach(function(t){Q(e,t,n[t])})}return e}({tag:e},t)))}constructor(e){Q(this,"listeners",new Map),Q(this,"packageName",void 0),this.packageName=e,D.event.addEventListener("onQAICMessage_".concat(e),e=>{var t;let n=JSON.parse(e),{tag:i}=n,o=function(e,t){if(null==e)return{};var n,i,o=function(e,t){if(null==e)return{};var n,i,o={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],!(t.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}(n,["tag"]);null==(t=this.listeners.get(i))||t(o)})}}function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let U="__hs__";class z extends J{async send(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.promise?await this.promise:await (this.promise=this._newPromise()),await super.send(...t)}setHandshakeListener(e){this.callback=e}get connected(){return null!==this.promise}_newPromise(){return new Promise((e,t)=>{let n=setTimeout(()=>{t(Error("timeout")),this.promise=this.resolve=null},3e3);this.resolve=()=>{e(),clearTimeout(n)},super.send(U,{count:0})})}constructor(e){super(e),M(this,"promise",null),M(this,"resolve",null),M(this,"timeout",null),M(this,"callback",()=>{}),D.event.addEventListener("onQAICMessage_".concat(e),e=>{var t;this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.promise=this.resolve=null,3e3);let n=JSON.parse(e),{tag:i}=n,o=function(e,t){if(null==e)return{};var n,i,o=function(e,t){if(null==e)return{};var n,i,o={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],!(t.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}(n,["tag"]);null==(t=this.listeners.get(i))||t(o)}),this.addListener(U,e=>{let{count:t}=e;if(t>0)if(this.promise){var n;null==(n=this.resolve)||n.call(this),this.resolve=null}else this.promise=Promise.resolve(),this.callback();t++<2&&super.send(U,{count:t})})}}function W(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(0===e)return"0 Bytes";let n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(t<0?0:t))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function Z(e){var t;return e&&null!=(t=e.replace(/\\/g,"/").split("/").pop())?t:""}function R(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class H{async sendFile(e,t,n,i,o,r,s){if(this.busy)return void s("A file transfer is already in progress.",0);if(this.busy=!0,this.onProgress=o,this.onSuccess=r,this.onError=s,this.lastChunkTime=0,this.totalChunk=Math.ceil(n/this.FILE_SIZE),this.chunkSize=Math.floor(i/this.totalChunk),0===this.totalChunk){r("File is empty, nothing to send.",0),this.busy=!1;return}this.curFile=t,o(0,"Preparing to send...");let l={stat:"startTransfer",filename:e,total:this.totalChunk,chunkSize:this.FILE_SIZE};try{this.nextChunk=D.filesystem.readFile(this.curFile,{offset:0,len:this.chunkSize,decode_text:!0}),await this.conn.send("file",l)}catch(e){this.onError("Failed to send start command: ".concat(e.message),0),this.busy=!1}}async sendNextChunk(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e>this.totalChunk)return void console.log("All chunks sent. Waiting for final 'success' confirmation from peer.");let n=await this.nextChunk,i=Date.now();if(0!==this.lastChunkTime){let t=i-this.lastChunkTime,n=this.FILE_SIZE/(t/1e3),o=(this.totalChunk-e)*(t/1e3);this.onProgress(e/this.totalChunk," ".concat(W(n),"/s, ").concat(Math.round(o),"s"))}else this.onProgress(e/this.totalChunk," --");this.lastChunkTime=i,e<this.totalChunk&&(this.nextChunk=D.filesystem.readFile(this.curFile,{offset:(e+1)*this.chunkSize,len:this.chunkSize,decode_text:!0})),this.conn.send("file",{stat:"d",count:e,data:n,setCount:t?e:null}).catch(t=>{this.onError("Failed to send chunk #".concat(e,": ").concat(t.message),e),this.busy=!1})}cancel(){this.busy&&(this.busy=!1,this.conn.send("file",{stat:"cancel"}).catch(e=>{console.error("Failed to send cancel message",e)}))}constructor(e){R(this,"conn",void 0),R(this,"FILE_SIZE",150),R(this,"curFile",""),R(this,"totalChunk",0),R(this,"lastChunkTime",0),R(this,"chunkSize",0),R(this,"busy",!1),R(this,"nextChunk",Promise.resolve("")),R(this,"onError",()=>{}),R(this,"onSuccess",()=>{}),R(this,"onProgress",()=>{}),this.conn=e,this.conn.addListener("file",e=>{if(!this.busy||!e){!e&&this.busy&&this.onError("Received incompatible (or empty) message from peer.",0);return}try{switch(e.type){case"ready":if(e.usage>0x1900000){this.onError("存储空间不足",0),this.busy=!1;return}if(e.found&&e.length&&e.length>0){let t=Math.floor(e.length/this.FILE_SIZE);this.nextChunk=D.filesystem.readFile(this.curFile,{offset:(t>this.totalChunk?0:t)*this.chunkSize,len:this.chunkSize,decode_text:!0}),this.sendNextChunk(t>this.totalChunk?0:t,!0)}else this.sendNextChunk(0);break;case"error":case"next":this.sendNextChunk(e.count);break;case"success":this.busy=!1,this.onProgress(1,"传输完成"),this.onSuccess(e.message,e.count);break;case"cancel":this.busy=!1,this.onSuccess("传输已取消",0)}}catch(t){console.error("Error processing file message:",e,t),this.onError("解析消息失败",0)}})}}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class K{constructor(e){G(this,"conn",void 0),this.conn=e,this.conn.addListener(K.name,async e=>{try{e.options||(e.options={});let t=function(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n.push.apply(n,i)}return n})(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e}(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),i.forEach(function(t){G(e,t,n[t])})}return e}({raw:!1},e.options),{headers:function(e){if(!e)return{};if(Array.isArray(e))return Object.fromEntries(e);if(!(e instanceof Headers))return e;{let t={};return e.forEach((e,n)=>{t[n]=e}),t}}(e.options.headers)}),n=await D.network.fetch(e.url,t);this.conn.send(K.name,{resp:n,id:e.id})}catch(e){console.error(e)}})}}G(K,"name","fetch");let Y=D.native.regNativeFun(()=>$()),q=D.native.regNativeFun(()=>ee()),V=D.native.regNativeFun(()=>et()),X=[{node_id:"pickFile",visibility:!0,disabled:!1,content:{type:"Button",value:{primary:!0,text:"选择文件",callback_fun_id:Y}}},{node_id:"send",visibility:!0,disabled:!0,content:{type:"Button",value:{primary:!0,text:"发送文件",callback_fun_id:q}}},{node_id:"filename",visibility:!0,disabled:!1,content:{type:"Text",value:"未选择文件"}},{node_id:"fuck",visibility:!0,disabled:!1,content:{type:"Text",value:"可能因为未知原因失败，多试试"}}];async function $(){try{(null==n?void 0:n.path)&&await D.filesystem.unloadFile(n.path)}catch(e){console.error(e),X[2].content.value=e.message,D.ui.updatePluginSettingsUI(X)}n=await D.filesystem.pickFile({decode_text:!0}),X[2]={node_id:"filename",visibility:!0,disabled:!1,content:{type:"Text",value:"".concat(Z(n.path),"\n").concat(W(n.size))}},X[1].disabled=!1,D.ui.updatePluginSettingsUI(X)}async function ee(){if(n){X[0].disabled=!0,X[1].content.value.text="取消",X[1].content.value.callback_fun_id=V,D.ui.updatePluginSettingsUI(X);try{let e=(await D.thirdpartyapp.getThirdPartyAppList()).find(e=>"com.charlie.hyperbox"==e.package_name);if(console.log(String(e)+"    @ 111111111111111111111111111111111111111111111111111111"),!e)return X[2].content.value="请先安装BandBBS客户端",D.ui.updatePluginSettingsUI(X);D.thirdpartyapp.launchQA(e,"/pages/push"),new Promise(e=>setTimeout(e,1e3)),await t.sendFile(Z(n.path),n.path,n.size,n.text_len,en,ei,eo)}catch(e){console.error(e),X[2].content.value=e.message,D.ui.updatePluginSettingsUI(X)}}}async function et(){t.cancel(),X[0].disabled=!1,X[1].content.value.text="发送文件",X[1].content.value.callback_fun_id=q,D.ui.updatePluginSettingsUI(X)}function en(e,t){X[2].content.value="".concat(t," ").concat((100*e).toFixed(2),"%"),D.ui.updatePluginSettingsUI(X)}function ei(){X[2].content.value="发送成功",D.ui.updatePluginSettingsUI(X)}function eo(){X[2].content.value="发送失败",D.ui.updatePluginSettingsUI(X)}D.lifecycle.onLoad(()=>{console.log("Plugin on LOAD!"),D.ui.updatePluginSettingsUI(X),t=new H(e=new z("com.charlie.hyperbox")),new K(e)})})();
//# sourceMappingURL=main.js.map